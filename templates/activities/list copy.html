{% extends "base.html" %}
{% block content %}
{% load humanize %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fs-5 fw-semibold mb-0">Activities</h2>
  {% if can_create %}<a href="{% url 'create_activity' %}" class="btn btn-sm btn-primary">+ Create Activity</a>{% endif %}
</div>

<div class="mb-4">
  <form method="get" class="row g-2 align-items-end" id="filterForm">
    <div class="col-md-2">
      <label class="form-label small">Search</label>
      <input type="text" name="q" class="form-control form-control-sm" placeholder="Name or ID" value="{{ filters.q|default:'' }}">
    </div>
    <div class="col-md-2">
      <label class="form-label small">Year</label>
      <select name="year" class="form-select form-select-sm auto-submit">
        <option value="">All</option>
        {% for y in years %}
          <option value="{{ y }}" {% if filters.year|stringformat:'s' == y|stringformat:'s' %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Status</label>
      <select name="status" class="form-select form-select-sm auto-submit">
        <option value="">All</option>
        {% for s in statuses %}
          <option value="{{ s.name }}" {% if filters.status == s.name %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Cluster</label>
      <select name="cluster" class="form-select form-select-sm auto-submit">
        <option value="">All</option>
        {% for c in clusters %}
          <option value="{{ c.short_name }}" {% if filters.cluster == c.short_name %}selected{% endif %}>{{ c.short_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Funder</label>
      <select name="funder" class="form-select form-select-sm auto-submit">
        <option value="">All</option>
        {% for f in funders %}
          <option value="{{ f.code }}" {% if filters.funder == f.code %}selected{% endif %}>{{ f.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-1">
      <label class="form-label small">Quarter</label>
      <select name="quarter" class="form-select form-select-sm auto-submit">
        <option value="">All</option>
        <option value="1" {% if filters.quarter == '1' %}selected{% endif %}>Q1</option>
        <option value="2" {% if filters.quarter == '2' %}selected{% endif %}>Q2</option>
        <option value="3" {% if filters.quarter == '3' %}selected{% endif %}>Q3</option>
        <option value="4" {% if filters.quarter == '4' %}selected{% endif %}>Q4</option>
      </select>
    </div>
    <div class="col-auto">
      <a href="{% url 'activities_list' %}" class="text-muted small text-decoration-none">Reset</a>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var filterForm = document.getElementById('filterForm');
    if (!filterForm) return;
    filterForm.addEventListener('change', function(e) {
      var t = e.target || e.srcElement;
      if (t && t.tagName && t.tagName.toLowerCase() === 'select') {
        filterForm.submit();
      }
    });
    // Submit on search input
    var searchInput = filterForm.querySelector('input[name="q"]');
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          filterForm.submit();
        }
      });
    }
  });
</script>

{% if can_create %}<div class="mb-3 p-3 bg-light border rounded">
  <form id="bulkActionForm" class="row g-2 align-items-end">
    {% csrf_token %}
    <div class="col-md-3">
      <label class="form-label small">Bulk Action</label>
      <select id="bulkAction" class="form-select form-select-sm">
        <option value="">Select action...</option>
        <option value="update_status">Update Status</option>
        <option value="delete">Mark as Deleted</option>
        <option value="assign_officer">Assign Officer</option>
      </select>
    </div>
    <div class="col-md-3" id="statusContainer" style="display:none;">
      <label class="form-label small">New Status</label>
      <select id="newStatus" class="form-select form-select-sm">
        <option value="">Select status...</option>
        {% for s in statuses %}
          <option value="{{ s.id }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3" id="officerContainer" style="display:none;">
      <label class="form-label small">Officer</label>
      <select id="newOfficer" class="form-select form-select-sm">
        <option value="">Select officer...</option>
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.get_full_name|default:u.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-sm btn-warning" onclick="executeBulkAction()">Apply to Selected</button>
    </div>
  </form>
</div>{% endif %}

<div class="table-responsive">
  <table id="activitiesTable" class="table table-sm table-hover">
    <thead class="table-light">
      <tr>
        {% if can_create %}<th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>{% endif %}
        <th>ID</th>
        <th>Name</th>
        <th>Cluster</th>
        <th>Funder</th>
        <th>Status</th>
        <th>Planned Month</th>
        <th>Quarter</th>
        <th>Responsible Officer</th>
        <th>Budget</th>
        <th>Disbursed</th>
        <th>Balance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for a in activities %}
        <tr>
          {% if can_create %}<td><input type="checkbox" class="activity-checkbox" value="{{ a.id }}"></td>{% endif %}
          <td><a class="text-primary text-decoration-none" href="{% url 'activity_detail' a.pk %}">{{ a.activity_id }}</a></td>
          <td>{{ a.name|truncatechars:60 }}</td>
          <td>{% for c in a.clusters.all %}{{ c.short_name }}{% if not forloop.last %}, {% endif %}{% empty %}N/A{% endfor %}</td>
          <td>{% for f in a.funders.all %}{{ f.name }}{% if not forloop.last %}, {% endif %}{% empty %}N/A{% endfor %}</td>
          <td><span class="badge bg-info">{{ a.status.name }}</span></td>
          <td>{{ a.planned_month|date:'Y-m-d' }}</td>
          <td>Q{{ a.quarter }}</td>
          <td>{% if a.responsible_officer %}{{ a.responsible_officer.get_full_name|default:a.responsible_officer.username }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
          <td>{{ a.total_budget|intcomma }}</td>
          <td>{{ a.disbursed_amount|intcomma }}</td>
          <td>{{ a.balance|intcomma }}</td>
          <td>
            <a href="{% url 'activity_detail' a.pk %}" class="btn btn-xs btn-outline-primary">View</a>
            {% if can_create %}<button type="button" class="btn btn-xs btn-outline-danger" onclick="deleteActivity({{ a.pk }})">Delete</button>{% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="13" class="text-center py-3 text-muted">No activities found</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Bulk action visibility toggle
  var bulkActionSelect = document.getElementById('bulkAction');
  if (bulkActionSelect) {
    bulkActionSelect.addEventListener('change', function() {
      document.getElementById('statusContainer').style.display = 
        this.value === 'update_status' ? 'block' : 'none';
      document.getElementById('officerContainer').style.display = 
        this.value === 'assign_officer' ? 'block' : 'none';
    });
  }
});

function toggleSelectAll() {
  var selectAll = document.getElementById('selectAll');
  var checkboxes = document.querySelectorAll('.activity-checkbox');
  checkboxes.forEach(function(checkbox) {
    checkbox.checked = selectAll.checked;
  });
}

function executeBulkAction() {
  var action = document.getElementById('bulkAction').value;
  if (!action) {
    alert('Please select an action');
    return;
  }
  
  var checkboxes = document.querySelectorAll('.activity-checkbox:checked');
  if (checkboxes.length === 0) {
    alert('Please select at least one activity');
    return;
  }
  
  if (!confirm('Are you sure? This action cannot be undone.')) {
    return;
  }
  
  var activityIds = Array.from(checkboxes).map(cb => cb.value);
  var payload = {
    action: action,
    activity_ids: activityIds
  };
  
  if (action === 'update_status') {
    var statusId = document.getElementById('newStatus').value;
    if (!statusId) {
      alert('Please select a status');
      return;
    }
    payload.status_id = statusId;
  } else if (action === 'assign_officer') {
    var officerId = document.getElementById('newOfficer').value;
    if (!officerId) {
      alert('Please select an officer');
      return;
    }
    payload.officer_id = officerId;
  }
  
  fetch('{% url "bulk_action" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Bulk action completed: ' + data.results.updated + ' activities updated');
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => alert('Error: ' + error));
}

function deleteActivity(id) {
  if (!confirm('Are you sure you want to delete this activity? This will mark it as retired.')) {
    return;
  }
  
  fetch('/activities/' + id + '/delete/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => alert('Error: ' + error));
}

$(document).ready(function() {
    $('#activitiesTable').DataTable({
        "paging": true,
        "pageLength": 25,
        "lengthChange": false,
        "searching": false,
        "ordering": false,
        "info": true
    });
});
</script>

{% endblock %}
