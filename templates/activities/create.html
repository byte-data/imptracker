{% extends "base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Activity{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'activities_list' %}">Activities</a></li>
<li class="breadcrumb-item active" aria-current="page">{% if form.instance.pk %}Edit{% else %}Create{% endif %}</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <h1 class="page-title">
        <i class="bi bi-{% if form.instance.pk %}pencil-square{% else %}plus-circle{% endif %} me-2"></i>
        {% if form.instance.pk %}Edit Activity{% else %}Create New Activity{% endif %}
    </h1>
    <p class="page-subtitle text-muted">
        {% if form.instance.pk %}Update activity information{% else %}Add a new implementation activity{% endif %}
    </p>
</div>

<!-- Activity Form Card -->
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Activity Name {% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.year.id_for_label }}" class="form-label">
                                Year {% if form.year.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.year }}
                            {% if form.year.errors %}
                                <div class="invalid-feedback d-block">{{ form.year.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                Status {% if form.status.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.planned_month.id_for_label }}" class="form-label">
                                Planned Month {% if form.planned_month.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.planned_month }}
                            {% if form.planned_month.errors %}
                                <div class="invalid-feedback d-block">{{ form.planned_month.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Clusters</label>
                            {{ form.clusters }}
                            {% if form.clusters.errors %}
                                <div class="invalid-feedback d-block">{{ form.clusters.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Funders</label>
                            {{ form.funders }}
                            {% if form.funders.errors %}
                                <div class="invalid-feedback d-block">{{ form.funders.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.currency.id_for_label }}" class="form-label">
                                Currency {% if form.currency.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.currency }}
                            {% if form.currency.errors %}
                                <div class="invalid-feedback d-block">{{ form.currency.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.total_budget.id_for_label }}" class="form-label">
                                Total Budget {% if form.total_budget.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.total_budget }}
                            {% if form.total_budget.errors %}
                                <div class="invalid-feedback d-block">{{ form.total_budget.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.disbursed_amount.id_for_label }}" class="form-label">Disbursed Amount</label>
                            {{ form.disbursed_amount }}
                            {% if form.disbursed_amount.errors %}
                                <div class="invalid-feedback d-block">{{ form.disbursed_amount.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.responsible_officer.id_for_label }}" class="form-label">Responsible Officer</label>
                        {{ form.responsible_officer }}
                        {% if form.responsible_officer.errors %}
                            <div class="invalid-feedback d-block">{{ form.responsible_officer.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">{{ form.notes.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Recurrence Section -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="bi bi-arrow-repeat me-2"></i>Recurring Activity Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                {{ form.is_recurring }}
                                <label class="form-check-label" for="{{ form.is_recurring.id_for_label }}">
                                    This is a recurring activity
                                </label>
                            </div>
                            <div class="row" id="recurrenceFields" style="display: none;">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.recurrence_pattern.id_for_label }}" class="form-label">Pattern</label>
                                    {{ form.recurrence_pattern }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.recurrence_interval.id_for_label }}" class="form-label">Repeat Every</label>
                                    {{ form.recurrence_interval }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.recurrence_end_date.id_for_label }}" class="form-label">End Date</label>
                                    {{ form.recurrence_end_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Procurement Section -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0"><i class="bi bi-cart me-2"></i>Procurement Information</h6>
                            <button type="button" class="btn btn-sm btn-success" id="addProcurementBtn" disabled>
                                <i class="bi bi-plus-circle me-1"></i>Add Item
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning alert-sm mb-3" id="budgetWarning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Please enter the <strong>Total Budget</strong> above before adding procurement items.
                            </div>
                            <div class="alert alert-info alert-sm mb-3" id="procurementInfo" style="display: none;">
                                <i class="bi bi-info-circle me-2"></i>
                                Add procurement items if this activity includes any purchases. The system will automatically determine if it's a full or partial procurement based on the total.
                            </div>
                            <div class="alert alert-danger alert-sm mb-3" id="budgetExceededWarning" style="display: none;">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                <strong>Warning:</strong> Total procurement amount exceeds the activity budget!
                            </div>
                            
                            <!-- Procurement Items Container -->
                            <div id="procurementItemsContainer">
                                <!-- Items will be added here dynamically -->
                            </div>
                            
                            <!-- Procurement Summary -->
                            <div class="d-flex justify-content-between align-items-center pt-3 border-top" id="procurementSummary" style="display: none !important;">
                                <div>
                                    <strong>Total Procurement:</strong>
                                    <span id="procurementTotal" class="text-primary fs-5">0.00</span>
                                </div>
                                <div id="procurementStatus" class="badge"></div>
                            </div>
                            
                            <!-- Hidden field to store JSON data -->
                            <input type="hidden" name="procurement_breakdowns" id="procurementBreakdownsData" value="">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                        <a href="{% if form.instance.pk %}{% url 'activity_detail' form.instance.pk %}{% else %}{% url 'activities_list' %}{% endif %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Save Activity
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
$(document).ready(function() {
    let procurementItems = [];
    let itemCounter = 0;
    
    // Procurement types from database
    const procurementTypes = [
        {% for ptype in procurement_types %}
        { code: '{{ ptype.code }}', name: '{{ ptype.name }}' }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Load existing procurement breakdowns if editing
    {% if form.instance.pk and form.instance.procurement_breakdowns %}
        procurementItems = {{ form.instance.procurement_breakdowns|safe }};
        procurementItems.forEach((item, index) => {
            item.id = index;
            itemCounter = index + 1;
        });
        renderProcurementItems();
        updateProcurementSummary();
    {% endif %}
    
    // Check if budget is entered and enable/disable procurement section
    function checkBudgetAndEnableProcurement() {
        const totalBudget = parseFloat($('#id_total_budget').val()) || 0;
        
        if (totalBudget > 0) {
            $('#addProcurementBtn').prop('disabled', false);
            $('#budgetWarning').hide();
            $('#procurementInfo').show();
        } else {
            $('#addProcurementBtn').prop('disabled', true);
            $('#budgetWarning').show();
            $('#procurementInfo').hide();
        }
    }
    
    // Toggle recurrence fields
    function toggleRecurrenceFields() {
        if ($('#id_is_recurring').is(':checked')) {
            $('#recurrenceFields').slideDown();
        } else {
            $('#recurrenceFields').slideUp();
        }
    }
    
    // Add procurement item
    $('#addProcurementBtn').on('click', function() {
        const totalBudget = parseFloat($('#id_total_budget').val()) || 0;
        
        if (totalBudget <= 0) {
            alert('Please enter the Total Budget before adding procurement items.');
            return;
        }
        
        const newItem = {
            id: itemCounter++,
            type: procurementTypes.length > 0 ? procurementTypes[0].code : 'equipment',
            amount: '',
            description: ''
        };
        procurementItems.push(newItem);
        renderProcurementItems();
        updateProcurementSummary();
    });
    
    // Render procurement items
    function renderProcurementItems() {
        const container = $('#procurementItemsContainer');
        container.empty();
        
        if (procurementItems.length === 0) {
            container.html('<p class="text-muted text-center py-3">No procurement items added yet. Click "+ Add Item" to begin.</p>');
            $('#procurementSummary').hide();
            return;
        }
        
        procurementItems.forEach((item, index) => {
            const itemHtml = `
                <div class="card mb-2 procurement-item" data-index="${index}" data-id="${item.id}">
                    <div class="card-body p-3">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label small">Type</label>
                                <select class="form-select form-select-sm item-type" data-index="${index}">
                                    ${procurementTypes.map(pt => 
                                        `<option value="${pt.code}" ${item.type === pt.code ? 'selected' : ''}>${pt.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Amount</label>
                                <input type="number" class="form-control form-control-sm item-amount" data-index="${index}" 
                                       value="${item.amount}" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label small">Description</label>
                                <input type="text" class="form-control form-control-sm item-description" data-index="${index}" 
                                       value="${item.description || ''}" placeholder="Brief description">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-outline-danger delete-item" data-index="${index}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.append(itemHtml);
        });
        
        $('#procurementSummary').show();
        
        // Bind events
        $('.item-type').on('change', function() {
            const index = $(this).data('index');
            procurementItems[index].type = $(this).val();
            updateProcurementData();
        });
        
        $('.item-amount').on('input', function() {
            const index = $(this).data('index');
            procurementItems[index].amount = parseFloat($(this).val()) || 0;
            updateProcurementSummary();
            updateProcurementData();
        });
        
        $('.item-description').on('input', function() {
            const index = $(this).data('index');
            procurementItems[index].description = $(this).val();
            updateProcurementData();
        });
        
        $('.delete-item').on('click', function() {
            const index = $(this).data('index');
            procurementItems.splice(index, 1);
            renderProcurementItems();
            updateProcurementSummary();
            updateProcurementData();
        });
    }
    
    // Update procurement summary
    function updateProcurementSummary() {
        const total = procurementItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
        $('#procurementTotal').text(total.toFixed(2));
        
        const totalBudget = parseFloat($('#id_total_budget').val()) || 0;
        const statusBadge = $('#procurementStatus');
        const exceededWarning = $('#budgetExceededWarning');
        
        // Check if procurement exceeds budget
        if (total > totalBudget && totalBudget > 0) {
            exceededWarning.show();
        } else {
            exceededWarning.hide();
        }
        
        if (total === 0) {
            statusBadge.hide();
        } else if (total >= totalBudget && totalBudget > 0) {
            statusBadge.show().removeClass('bg-warning').addClass('bg-success')
                .text('Full Procurement Activity');
        } else {
            statusBadge.show().removeClass('bg-success').addClass('bg-warning')
                .text('Partial Procurement');
        }
    }
    
    // Update hidden field with JSON data
    function updateProcurementData() {
        const jsonData = JSON.stringify(procurementItems);
        $('#procurementBreakdownsData').val(jsonData);
    }
    
    // Update summary when total budget changes
    $('#id_total_budget').on('input', function() {
        checkBudgetAndEnableProcurement();
        updateProcurementSummary();
    });
    
    // Initialize on page load
    toggleRecurrenceFields();
    checkBudgetAndEnableProcurement();
    
    // Bind events
    $('#id_is_recurring').on('change', toggleRecurrenceFields);
    
    // Before form submit, validate and ensure procurement data is updated
    $('form').on('submit', function(e) {
        updateProcurementData();
        
        // Validate procurement doesn't exceed budget
        const total = procurementItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
        const totalBudget = parseFloat($('#id_total_budget').val()) || 0;
        
        if (total > totalBudget && totalBudget > 0) {
            e.preventDefault();
            alert('Error: Total procurement amount (' + total.toFixed(2) + ') exceeds the activity budget (' + totalBudget.toFixed(2) + '). Please adjust the procurement items or increase the total budget.');
            return false;
        }
    });
});
</script>
{% endblock %}
