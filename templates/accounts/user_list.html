{% extends "base.html" %}
{% load static %}

{% block title %}User Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Users</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-people me-2"></i>User Management
            </h1>
            <p class="page-subtitle text-muted mb-0">Manage system users and permissions</p>
        </div>
        <a href="{% url 'accounts:user_create' %}" class="btn btn-success">
            <i class="bi bi-person-plus me-2"></i>Create User
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Roles</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_obj in users %}
                    <tr>
                        <td><strong>{{ user_obj.username }}</strong></td>
                        <td>{{ user_obj.get_full_name|default:"-" }}</td>
                        <td>{{ user_obj.email|default:"-" }}</td>
                        <td>
                            {% for group in user_obj.groups.all %}
                                <span class="badge bg-light text-dark">{{ group.name }}</span>
                            {% empty %}
                                <span class="text-muted">-</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if user_obj.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <a href="{% url 'accounts:user_edit' user_obj.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showResetPassword('{{ user_obj.pk }}', '{{ user_obj.username }}')">
                                Reset Password
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeactivate('{{ user_obj.pk }}', '{{ user_obj.username }}')">
                                Deactivate
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password for <span id="resetUsername"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" class="form-control" id="newPassword">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="resetPassword()">Set Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Deactivate Confirmation Modal -->
<div class="modal fade" id="deactivateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to deactivate the user <strong id="deactivateUsername"></strong>?
            </div>
            <div class="modal-footer">
                <form id="deactivateForm" method="post">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Deactivate</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
let currentUserId = null;

function showResetPassword(userId, username) {
    currentUserId = userId;
    document.getElementById('resetUsername').textContent = username;
    document.getElementById('newPassword').value = '';
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

function resetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    if (!newPassword) {
        alert('Please enter a new password.');
        return;
    }
    
    const formData = new FormData();
    formData.append('new_password', newPassword);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/accounts/users/${currentUserId}/reset-password/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password reset successfully.');
            bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
        } else {
            alert('Failed to reset password: ' + (data.error || 'Unknown error'));
        }
    });
}

function confirmDeactivate(userId, username) {
    document.getElementById('deactivateUsername').textContent = username;
    document.getElementById('deactivateForm').action = `/accounts/users/${userId}/delete/`;
    new bootstrap.Modal(document.getElementById('deactivateModal')).show();
}

document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('usersTable')) {
        const table = new DataTable('#usersTable', {
            pageLength: 25,
            order: [[0, 'asc']],
            columnDefs: [{ orderable: false, targets: [3, 4, 5] }]
        });
        
        // Clear any existing search on page load
        table.search('').draw();
        
        // Disable autocomplete on the search input to prevent browser autofill
        const searchInput = document.querySelector('.dataTables_filter input');
        if (searchInput) {
            searchInput.setAttribute('autocomplete', 'off');
            searchInput.setAttribute('data-form-type', 'other');
        }
    }
});
</script>
{% endblock %}
