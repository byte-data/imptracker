{% extends "base.html" %}
{% load humanize %}

{% block title %}Upload Activities{% endblock %}

{% block extra_head %}
<style>
.spinner-border-sm {
  width: 1rem;
  height: 1rem;
}
.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Upload</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <h1 class="page-title">
        <i class="bi bi-cloud-upload me-2"></i>Upload Activities
    </h1>
    <p class="page-subtitle text-muted">Import activities from Excel file</p>
</div>

{% if errors %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-circle me-2"></i>
    <strong>Upload Error</strong>
    <ul class="mb-0 mt-2">
    {% for e in errors %}<li>{{ e }}</li>{% endfor %}
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
{% endif %}

{% if created or updated or skipped %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>
    <strong>Upload Complete!</strong>
    <ul class="mb-0 mt-2">
      {% if created %}<li>Created {{ created }} new activities</li>{% endif %}
      {% if updated %}<li>Updated {{ updated }} activities</li>{% endif %}
      {% if skipped %}<li>Skipped {{ skipped }} activities</li>{% endif %}
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
{% endif %}

<div class="card">
  <div class="card-header">
    <h5 class="card-title mb-0">
      <i class="bi bi-file-earmark-spreadsheet me-2"></i>Upload File (CSV or Excel)
    </h5>
  </div>
  <div class="card-body position-relative">
    <div id="confirmLoading" class="loading-overlay d-none">
      <div class="text-center">
        <div class="spinner-border text-primary mb-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">Loading activities...</p>
      </div>
    </div>
    {% if summary %}
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <strong>File Staged:</strong> {{ staged_file }}
      </div>

      <!-- Summary Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="stats-card border-primary">
            <div class="card-body">
              <p class="stats-label text-primary mb-1">Total Rows</p>
              <h3 class="stats-value">{{ summary.total_rows }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card border-success">
            <div class="card-body">
              <p class="stats-label text-success mb-1">Budget Sum</p>
              <h3 class="stats-value">ZMK {{ summary.budget_sum|floatformat:2|intcomma|default:"0" }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card border-info">
            <div class="card-body">
              <p class="stats-label text-info mb-1">Disbursed Sum</p>
              <h3 class="stats-value">ZMK {{ summary.disbursed_sum|floatformat:2|intcomma|default:"0"  }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card border-warning">
            <div class="card-body">
              <p class="stats-label text-warning mb-1">Invalid Dates</p>
              <h3 class="stats-value">{{ summary.invalid_dates }}</h3>
              <p class="text-muted small mb-0">
                {% if summary.first_date %}{{ summary.first_date }} to {{ summary.last_date }}{% else %}No valid dates{% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Breakdown -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-3 text-primary">
                <i class="bi bi-diagram-3 me-2"></i>Clusters
              </h6>
              {% if summary.clusters %}
                <ul class="list-unstyled mb-0">
                  {% for c,count in summary.clusters %}
                    <li class="d-flex justify-content-between align-items-center py-1">
                      <span>{{ c }}</span>
                      <span class="badge bg-primary">{{ count }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">No cluster data</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-3 text-success">
                <i class="bi bi-bank me-2"></i>Funders
              </h6>
              {% if summary.funders %}
                <ul class="list-unstyled mb-0">
                  {% for f,count in summary.funders %}
                    <li class="d-flex justify-content-between align-items-center py-1">
                      <span>{{ f }}</span>
                      <span class="badge bg-success">{{ count }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">No funder data</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-3 text-info">
                <i class="bi bi-flag me-2"></i>Statuses
              </h6>
              {% if summary.status_checks %}
                <ul class="list-unstyled mb-0">
                  {% for item in summary.status_checks %}
                    <li class="d-flex justify-content-between align-items-center py-1">
                      <span>
                        {% if item.valid %}
                          <i class="bi bi-check-circle-fill text-success me-2"></i>
                        {% else %}
                          <i class="bi bi-x-circle-fill text-danger me-2"></i>
                        {% endif %}
                        {{ item.name }}
                      </span>
                      <span class="badge bg-info">{{ item.count }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">No status data</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if summary.unknown_statuses or summary.default_status_missing %}
        <div class="alert alert-danger d-flex align-items-start">
          <i class="bi bi-exclamation-octagon me-2 mt-1"></i>
          <div>
            <h6 class="alert-heading mb-1">Upload blocked: Unknown status values</h6>
            <p class="mb-1">Ask the system admin to add the missing status values in Activity Status, or use any of the existing status values listed below.</p>
            {% if summary.unknown_statuses %}
              <div class="small text-muted">Missing: {{ summary.unknown_statuses|join:", " }}</div>
            {% endif %}
            {% if summary.available_statuses %}
              <div class="small text-muted">Available: {{ summary.available_statuses|join:", " }}</div>
            {% endif %}
            {% if summary.default_status_missing %}
              <div class="small text-muted">"Not Implemented" status is required for empty/blank statuses.</div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      {% if summary.duplicates or summary.updates %}
        <div class="alert alert-warning d-flex align-items-start">
          <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
          <div>
            <h6 class="alert-heading mb-2">Attention Required</h6>
            {% if summary.updates %}
              <p class="mb-2">Found {{ summary.updates|length }} row(s) with Activity IDs that will update existing records.</p>
            {% endif %}
            {% if summary.duplicates %}
              <p class="mb-0">Found {{ summary.duplicates|length }} potential duplicate(s). Please review and choose action below.</p>
            {% endif %}
          </div>
        </div>

        <form method="post" id="confirmForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="confirm" />

          {% if summary.unknown_funders or summary.unknown_clusters %}
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="bi bi-question-circle me-2"></i>Unknown Masters
                </h6>
                <small class="text-muted">Confirm creation or mapping</small>
              </div>
              <div class="card-body">
                {% if summary.unknown_funders_details %}
                  <h6 class="mb-3">Funders not found:</h6>
                  {% for f in summary.unknown_funders_details %}
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" name="create_funder" value="{{ f.name }}" id="create_funder_{{ forloop.counter }}">
                      <label class="form-check-label" for="create_funder_{{ forloop.counter }}">
                        Create funder "{{ f.name }}"
                      </label>
                      {% if f.suggestions %}
                        <div class="small text-muted ms-4">Similar: {{ f.suggestions|join:", " }}</div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% endif %}
                {% if summary.unknown_clusters_details %}
                  <h6 class="mb-3 mt-4">Clusters not found:</h6>
                  {% for c in summary.unknown_clusters_details %}
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" name="create_cluster" value="{{ c.name }}" id="create_cluster_{{ forloop.counter }}">
                      <label class="form-check-label" for="create_cluster_{{ forloop.counter }}">
                        Create cluster "{{ c.name }}"
                      </label>
                      {% if c.suggestions %}
                        <div class="small text-muted">Similar: {{ c.suggestions|join:", " }}</div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          {% endif %}

          {% if summary.updates %}
            <div class="card mb-3">
              <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                  <i class="bi bi-arrow-repeat me-2"></i>
                  Updates ({{ summary.updates|length }})
                </h6>
                <small>These rows have Activity IDs and will update existing records</small>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead>
                      <tr>
                        <th>Row</th>
                        <th>Activity ID</th>
                        <th>New Name</th>
                        <th>Existing Name</th>
                        <th style="width: 150px;">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in summary.updates %}
                        <tr>
                          <td>{{ item.row }}</td>
                          <td><span class="badge bg-primary">{{ item.activity_id }}</span></td>
                          <td>{{ item.name }}</td>
                          <td class="text-muted">{{ item.existing_name }}</td>
                          <td>
                            <select name="row_{{ item.row }}" class="form-select form-select-sm row-action">
                              <option value="">-- Select --</option>
                              <option value="create">Update</option>
                              <option value="skip">Skip</option>
                            </select>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          {% endif %}

          {% if summary.duplicates %}
            <div class="card mb-3">
              <div class="card-header bg-warning">
                <h6 class="card-title mb-0">
                  <i class="bi bi-exclamation-diamond me-2"></i>
                  Potential Duplicates ({{ summary.duplicates|length }})
                </h6>
                <small>Review these rows carefully</small>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead>
                      <tr>
                        <th>Row</th>
                        <th>Upload Name</th>
                        <th>Existing Activity</th>
                        <th>Year/Cluster</th>
                        <th style="width: 150px;">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in summary.duplicates %}
                        <tr>
                          <td>{{ item.row }}</td>
                          <td>{{ item.name }}</td>
                          <td>
                            <span class="badge bg-secondary">{{ item.existing_id }}</span>
                            <div class="small text-muted mt-1">{{ item.existing_name }}</div>
                          </td>
                          <td><small>{{ item.existing_year }} / {{ item.existing_cluster }}</small></td>
                          <td>
                            <select name="row_{{ item.row }}" class="form-select form-select-sm row-action">
                              <option value="">-- Select --</option>
                              <option value="create">Create Anyway</option>
                              <option value="skip">Skip</option>
                            </select>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          {% endif %}

          <div class="d-flex justify-content-between align-items-center mt-4">
            <button type="submit" class="btn btn-success" id="submitBtn" {% if summary.unknown_statuses or summary.default_status_missing %}disabled{% endif %}>
              <i class="bi bi-check-circle me-2"></i>Confirm & Load Activities
            </button>
            <a href="{% url 'upload_activities' %}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </a>
          </div>
        </form>

        <script>
          document.getElementById('confirmForm').addEventListener('submit', function(e) {
            // Check if all row-action selects have a value
            var emptySelects = document.querySelectorAll('.row-action');
            var hasEmpty = false;
            
            emptySelects.forEach(function(select) {
              if (select.value === '') {
                hasEmpty = true;
              }
            });
            
            if (hasEmpty) {
              e.preventDefault();
              return false;
            }

            // If unknown masters exist, ensure at least one creation checkbox is checked for each unknown
            var unknownF = document.querySelectorAll('input[name="create_funder"]');
            var unknownC = document.querySelectorAll('input[name="create_cluster"]');
            var missingConfirm = false;
            if (unknownF.length) {
              unknownF.forEach(function(ch){
                // if any unchecked, require user to check (we assume each unknown appears once)
                if (!ch.checked) missingConfirm = true;
              });
            }
            if (unknownC.length) {
              unknownC.forEach(function(ch){ if (!ch.checked) missingConfirm = true; });
            }
            if (missingConfirm) {
              e.preventDefault();
              return false;
            }
            
            // Show loading spinner
            const loading = document.getElementById('confirmLoading');
            const btn = document.getElementById('submitBtn');
            loading.classList.remove('d-none');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading...';
          });
        </script>
      {% else %}
        <form method="post" id="confirmFormSimple">
          {% csrf_token %}
          <input type="hidden" name="action" value="confirm" />
          {% if summary.unknown_funders or summary.unknown_clusters %}
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="bi bi-question-circle me-2"></i>Unknown Masters
                </h6>
              </div>
              <div class="card-body">
                {% if summary.unknown_funders %}
                  <h6 class="mb-3">Funders not found:</h6>
                  {% for f in summary.unknown_funders %}
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" name="create_funder" value="{{ f }}" id="create_funder_s_{{ forloop.counter }}">
                      <label class="form-check-label" for="create_funder_s_{{ forloop.counter }}">
                        Create funder "{{ f }}"
                      </label>
                    </div>
                  {% endfor %}
                {% endif %}
                {% if summary.unknown_clusters %}
                  <h6 class="mb-3 mt-4">Clusters not found:</h6>
                  {% for c in summary.unknown_clusters %}
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" name="create_cluster" value="{{ c }}" id="create_cluster_s_{{ forloop.counter }}">
                      <label class="form-check-label" for="create_cluster_s_{{ forloop.counter }}">
                        Create cluster "{{ c }}"
                      </label>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          {% endif %}
          <button type="submit" class="btn btn-success" {% if summary.unknown_statuses or summary.default_status_missing %}disabled{% endif %}>
            <i class="bi bi-check-circle me-2"></i>Load Activities
          </button>
        </form>
        <script>
          // Ensure the user confirms creation for unknown masters when present
          document.getElementById('confirmFormSimple')?.addEventListener('submit', function(e){
            var unknowns = document.querySelectorAll('input[name="create_funder"], input[name="create_cluster"]');
            if (unknowns.length) {
              var anyChecked = false;
              unknowns.forEach(function(ch){ if (ch.checked) anyChecked = true; });
              if (!anyChecked) {
                e.preventDefault();
                return;
              }
            }
            
            // Show loading spinner
            const loading = document.getElementById('confirmLoading');
            const btn = this.querySelector('button[type="submit"]');
            loading.classList.remove('d-none');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading...';
          });
        </script>
      {% endif %}
    {% else %}
      <!-- Upload Form -->
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body position-relative">
              <div id="uploadLoading" class="loading-overlay d-none">
                <div class="text-center">
                  <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mb-0">Processing file...</p>
                </div>
              </div>
              <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="mb-3">
                  {% comment %} <label class="form-label fw-semibold mb-3">
                    <i class="bi bi-file-earmark-arrow-up me-2"></i>CSV or Excel file
                  </label> {% endcomment %}
                  
                  <!-- Drag and Drop Area -->
                  <div id="dropZone" class="border-2 border-dashed rounded-3 p-4 text-center bg-light position-relative" style="border-color: #dee2e6; cursor: pointer; transition: all 0.3s;">
                    <input type="file" name="file" id="fileInput" class="position-absolute" style="opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;" accept=".csv,.xlsx,.xls" required />
                    
                    <div id="dropZoneContent">
                      <i class="bi bi-cloud-arrow-up display-6 text-muted mb-2 d-block"></i>
                      <h5 class="mb-2">Drag & Drop your file here</h5>
                      <p class="text-muted mb-2">or</p>
                      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('fileInput').click();">
                        <i class="bi bi-folder2-open me-2"></i>Browse Files
                      </button>
                      <p class="text-muted small mt-3 mb-0">
                        Supported formats: CSV, Excel (.xlsx, .xls)
                      </p>
                    </div>
                    
                    <div id="fileInfo" class="d-none">
                      <i class="bi bi-file-earmark-check display-6 text-success mb-2 d-block"></i>
                      <h5 id="fileName" class="mb-2"></h5>
                      <p id="fileSize" class="text-muted mb-3"></p>
                      <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearFile();">
                        <i class="bi bi-x-circle me-1"></i>Remove File
                      </button>
                    </div>
                  </div>
                  
                  <div class="form-text mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    Step 1: Upload to preview summary. Step 2: Load activities.
                  </div>
                </div>
                <button type="submit" class="btn btn-success" id="uploadBtn" disabled>
                  <i class="bi bi-cloud-arrow-up me-2"></i>Upload & Preview
                </button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body d-flex flex-column justify-content-center text-center">
              <div class="mb-3">
                <i class="bi bi-file-earmark-spreadsheet display-4 text-success"></i>
              </div>
              <h6 class="fw-bold mb-2">Need a template?</h6>
              <p class="small text-muted mb-3">Download our Excel template to ensure your file has the correct format and column headers.</p>
              <a href="{% url 'download_template' %}" class="btn btn-sm btn-secondary w-40">
                <i class="bi bi-download me-1"></i> Download
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <script>
        // Drag and Drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const dropZoneContent = document.getElementById('dropZoneContent');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadBtn = document.getElementById('uploadBtn');
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }
        
        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
          dropZone.style.borderColor = '#0d6efd';
          dropZone.style.backgroundColor = '#e7f1ff';
        }
        
        function unhighlight(e) {
          dropZone.style.borderColor = '#dee2e6';
          dropZone.style.backgroundColor = '#f8f9fa';
        }
        
        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          
          if (files.length > 0) {
            fileInput.files = files;
            displayFileInfo(files[0]);
          }
        }
        
        // Handle file selection via input
        fileInput.addEventListener('change', function(e) {
          if (this.files.length > 0) {
            displayFileInfo(this.files[0]);
          }
        });
        
        function displayFileInfo(file) {
          // Check file type
          const validTypes = ['.csv', '.xlsx', '.xls'];
          const fileExt = '.' + file.name.split('.').pop().toLowerCase();
          
          if (!validTypes.includes(fileExt)) {
            alert('Invalid file type. Please upload a CSV or Excel file.');
            clearFile();
            return;
          }
          
          // Display file info
          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);
          
          dropZoneContent.classList.add('d-none');
          fileInfo.classList.remove('d-none');
          uploadBtn.disabled = false;
        }
        
        function clearFile() {
          fileInput.value = '';
          dropZoneContent.classList.remove('d-none');
          fileInfo.classList.add('d-none');
          uploadBtn.disabled = true;
          unhighlight();
        }
        
        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Handle upload form submission
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
          const loading = document.getElementById('uploadLoading');
          const btn = document.getElementById('uploadBtn');
          
          // Show loading overlay
          loading.classList.remove('d-none');
          
          // Disable button and change text
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
        });
      </script>
    {% endif %}
  </div>
</div>
{% endblock %}
